<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://earth.google.com/kml/2.1">
<Document>  
  <Style id="documentStyle">
    <IconStyle>
      <Icon>
        <href>http://www.iconspedia.com/uploads/1912642692.png</href>
      </Icon>
    </IconStyle>
  </Style>
  
  <Style id="overlayStyle"> <!-- style for ScreenOverlay -->
    <BalloonStyle>
      <displayMode>undecorated</displayMode>
    </BalloonStyle>
  </Style>
  
  <Style id="flickrStyle"> <!-- style for placemarkers -->
    <IconStyle>
      <scale>1.0</scale>
      <Icon>
        <href>http://www.iconspedia.com/uploads/1912642692.png</href> <!-- url to twitter logo -->
      </Icon>
      <hotSpot x="0.5" y="0" xunits="fraction" yunits="fraction" />
    </IconStyle>
  </Style>
  
  
  <ScreenOverlay>
    <name>myOverlay</name>
      <description><![CDATA[
        
      <script type="text/javascript">
      
        function removePlacemarkers() //called in between searches to clear out old placemarkers before new ones are added
        {
          for (kmlObjId in KHARMA.dom.elements)
          {
            var kmlObj = KHARMA.dom.elements[kmlObjId];
            var feature = document.getElementById(kmlObj.id);
            if (feature && kmlObjId.substring(0,2) == 'PM') //only removes objects with the substring "PM" at the beginning of their id (short for "PlaceMarker").  without this extra condition, this function would remove everything in the scene, including the UI
            {
              
              //var distance = $(feature).data("distance");
              //console.log("***** " + distance);
              $(feature).remove();
              KHARMA.dom.removeElementWithID(kmlObj.id);
            }
          }
        }


        
        
        function flickrSearch() //called when submit button is pressed
        {  
          document.getElementById("spinDiv").style.visibility = "visible";
          
          removePlacemarkers(); //clear out old placemarkers, if any
          
          var search = document.getElementById("keywordTxt").value;
          //var hashtag = document.getElementById("hashtagTxt").value;
          var results = "10";
          //var radius = "5km";
          
          
          var myLoc = KHARMA.getLocation();                                    
          var myLat = myLoc.latitude;
          var myLon = myLoc.longitude;
          
          //build the URL that requests data from twitter.com
          var url='http://pipes.yahoo.com/pipes/pipe.run?_id=92f73daf15830031e003f03245f25eb6&_render=json&_callback=?&lat=' + myLat + '&lon=' + myLon + '&results=' + results + '&search=' + search;
    
          var resultCount = 0;
          
          $.getJSON(url,function(json) //get JSON data from twitter.com
          {
            $.each(json.value.items,function(i,flickr)
            {
              resultCount++;
              
              var pmLat = flickr["geo:lat"]
              var pmLon = flickr["geo:long"]
              var title = flickr.title;
              var imgURL = flickr["y:flickr"].img;
              
              var maxHeight = 220;
              var maxWidth = 280;
              
              var xOffset = 10;
              var yOffset = 55;
              
              var imgHeight = maxHeight;
              var imgWidth = maxWidth;
              
              
              
              var newImg = new Image();
              newImg.onload = function()
              {
              
                imgHeight = newImg.height;
                imgWidth = newImg.width;
                
                var scaledHeight = maxHeight;
                var scaledWidth = maxWidth;
                
                
                if(imgHeight/maxHeight > imgWidth/maxWidth) //use height as definer of size
                {
                  scaledHeight = maxHeight;
                  scaledWidth = maxHeight/imgHeight * imgWidth;
                }
                else //use width as definer of size
                {
                  scaledWidth = maxWidth;
                  scaledHeight = maxWidth/imgWidth * imgHeight;
                }
                
                var leftCenter = (maxWidth - scaledWidth)/2 + xOffset;
                var topCenter = (maxHeight - scaledHeight)/2 + yOffset;
                
                
                //use the twitter JSON to construct a new placemark JSON object
                var myPlacemarkJSON =  
                {   
                  description : "<div class='imageStyle' style='left:" + leftCenter + "px; top:" + topCenter + "px;'><img src=" +imgURL + " width=" + scaledWidth + " height=" + scaledHeight + "/></div>",
                  iconVisibility : "1",
                  id : "PM" + i,
                  labelVisibility : "1",
                  name : title,
                  type : "placemark",
                  visibility : "1",
                  balloonVisibility : "0",
                  geometry :      [{ 
                           id : "GEO" + i,
                           latitude : pmLat,
                           longitude : pmLon,
                           altitude : "0",
                           type : "point" 
                           }],
                  styleUrl : "#flickrStyle"
                };
                var myPlacemark = new KMLPlacemark(myPlacemarkJSON);
              
              }; //end onload
              
              newImg.src = imgURL;
            });
            
            renderKMLObjects();
            
            var resultLabel = "results";
            if(resultCount == 1) resultLabel = "result";
            document.getElementById("resultCountDiv").innerHTML = resultCount + " " + resultLabel;
            
            document.getElementById("spinDiv").style.visibility = "hidden";
          });
        }

      </script> 
      
      <style type="text/css">
        div.inputStyle
        {
          width:            360px;
          height:            85px;
          left:            -20px;
          top:            -20px;
          position:           absolute;
      
          background-color:      rgba(220, 234, 255, 0.7);
          border-style:        solid;
          border-width:        1px;
          border-color:        rgba(0, 0, 0, 1.0);
        }
        
        div.searchButtonStyle
        {
          width:            36px;
          height:            36px;
          left:            280px;
          top:            44px;
          position:           absolute;
        }
        
        div.textStyle
        {
          width:            150px;
          height:            36px;
          left:            20px;
          top:            40;
          position:           absolute;
          
          font-family:        sans-serif;
          font-size:          10px;
        }
        
        div.imageStyle
        {
          width:            300px;
          height:            220px;
          left:            10px;
          top:            60;
          position:           absolute;
          
          font-family:        sans-serif;
          font-size:          10px;
          text-align:          center;
        }
        
        div.labelStyle
        {
          width:            210px;
          height:            36px;
          left:            55px;
          top:            10px;
          position:           absolute;
          
          font-family:        sans-serif;
          font-size:          12px;
          vertical-align:        bottom;
          text-align:          left;
          color:            rgba(0, 0, 0, 1);
        }
        
        div.iconStyle
        {
          width:            24px;
          height:            24px;
          left:            25px;
          top:            13px;
          position:           absolute;
        }
        
        div.resultCountStyle
        {
          width:            150px;
          height:            36px;
          left:            166px;
          top:            23px;
          position:           absolute;
          
          font-family:        sans-serif;
          font-size:          8px;
          vertical-align:        bottom;
          text-align:          right;
          color:            rgba(0, 0, 0, 1);
        }
      </style>
      
  
      <div id="searchDiv" class="inputStyle">
        <form name="input" action="javascript:flickrSearch();" method="get">
          <div id="iconDiv" class="iconStyle"><img src="http://www.iconspedia.com/uploads/1912642692.png" height="24" width="24" /></div>
          <div id="labelDiv" class="labelStyle">Flickr Search</div>
          <div id="textDiv" class="textStyle"><input id="keywordTxt" size="18" type="text" value=""/></div>
          <div id"searchDiv" class="searchButtonStyle" ><input type="image" src="http://isaackulka.com/images/search.gif" alt="Submit" /></div>
          <div id="spinDiv" class="searchButtonStyle" style="visibility:hidden;"><img src="http://isaackulka.com/images/spinner.gif" /></div>
          <div id="resultCountDiv" class="resultCountStyle"></div>
          
        </form>
      </div>
      
    ]]></description>
      
      
      
    <overlayXY x="0.5" y="0.5" xunits="fraction" yunits="fraction"/> 
    <screenXY x="0.01" y="1.0" xunits="fraction" yunits="fraction"/>
    <size x="0" y="0" xunits="pixels" yunits="pixels"/>
    
    <styleUrl>#overlayStyle</styleUrl>  
  
  </ScreenOverlay>
  
  <styleUrl>#documentStyle</styleUrl> 
  
  <!-- KML document description -->
  <name>Flickr Search</name>
  <Snippet>Flickr Search for Argon</Snippet>
  <description><![CDATA[
    <div><p><b>Flickr Search for Argon</b></p>
    <p>
    <b>notes:</b>
    <ul>
    <li>Searches for geo-tagged Flickr photos within 5km of user's current location
    <li>Displays photos as icons within the AR browser's viewing space
    <li>Click on icons to view larger photo<br>
    <li>The javascript functions use JQuery to retrieve JSON data from a Flickr search built within the Yahoo Pipes framework
    <li>The pipes JSON data is then used to create new JSON placemark objects that are then turned into new KML placemarks
    <li>Once the kml placemarks have been rendered in the display, the user may begin interacting with them
    </ul>
  ]]></description>   
  
</Document>
</kml>